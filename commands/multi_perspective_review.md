---
description: "複数の視点から客観的にレビューし、方針の妥当性を検証します。"
allowed-tools: Bash(git diff:*), Bash(git log:*), Bash(git symbolic-ref refs/remotes/origin/HEAD --short)
---

# 複数視点レビューコマンド

<important>

このコマンドは以下の場合に使用してください：

- 実装方針や設計の妥当性を確認したい
- 複数の視点から客観的な意見が欲しい
- 早すぎる最適化やnit な指摘を避けたい
- プロジェクトの現状に合った判断をしたい

</important>

## 実行手順

<procedure>

**1. コンテキストの収集**

<context>

まず、レビューに必要なコンテキストを収集します：

- **デフォルトブランチの取得**

   ```bash
   git symbolic-ref refs/remotes/origin/HEAD --short
   ```

   結果は `origin/main` のような形式なので、後続の処理で使用します

- **現在の変更差分を取得（あれば）**

   デフォルトブランチとの差分を取得：

   ```bash
   git diff <デフォルトブランチ名>
   ```

   例: `git diff origin/main`

   ※ 変更がない場合も問題なし。これから実装する方針のレビューなど、コード差分がない場合もある

- **デフォルトブランチからの差分コミット履歴を取得**

   現在のブランチがデフォルトブランチと異なる場合、差分コミットを取得：

   ```bash
   git log <デフォルトブランチ名>..HEAD --oneline
   ```

   例: `git log origin/main..HEAD --oneline`

   ※ 現在のブランチがデフォルトブランチと同じ場合は、このステップはスキップ

- **会話履歴の確認（重要）**

   - 直前のユーザーとのやり取りから、レビュー対象の意図を把握する
   - 「この方針で良いか確認したい」「この設計をレビューして」などの説明
   - git diffがない場合は、会話履歴が主なコンテキストになる

</context>

**2. 第1ラウンド: 8つの視点からのレビュー**

収集したコンテキストを基に、8つの異なる視点からレビューを実施します。

**並列実行**: 8つのTaskツール（`subagent_type: "general-purpose"`）を同時に呼び出し、効率的にレビューを実施してください。

各general-purpose subagentには以下の情報を含めたプロンプトを渡します：

```
あなたは <name>テスタビリティ</name> の観点から、以下の内容をレビューしてください。

## レビュー対象

以下は<context>タグで定義した手順に従って収集したデータです。

[git diff、git log、会話履歴などのデータをここに記載]

## レビューの指針
- 客観的な視点から意見を述べてください
- 修正案の提示は不要です（分析と意見のみ）
- 具体的なコードや状況に即した指摘をしてください
- 抽象的すぎる指摘は避けてください

## あなたの視点

<perspective-details>タグで定義された内容を参照してください。

1文から3文程度で、要点を簡潔に述べてください。
```

<examples>

<example>
<name>アーキテクチャ・設計</name>:

<perspective-details>

- システム全体の構造が適切か
- モジュール分割が適切か
- 依存関係が適切に管理されているか
- 拡張性が考慮されているか
- 設計原則が遵守されているか

</perspective-details>

</example>

<example>
<name>パフォーマンス・効率性</name>:

<perspective-details>

- 実行速度に問題がないか
- メモリ使用量が適切か
- スケーラビリティが考慮されているか
- アルゴリズムの計算量が適切か

</perspective-details>

</example>

<example>
<name>保守性・可読性</name>:

<perspective-details>

- コードが理解しやすいか
- 変更がしやすい構造になっているか
- 命名規則が適切か
- 使われていない関数や変数はないか
- コメントが適切に記述されているか（自明なコメントが付与されていないか）
- コメントと関数名、関数名と実際の処理で乖離がないか
- 類似の機能を持つコードが重複していないか
- 複雑度が適切に管理されているか

</perspective-details>

</example>

<example>
<name>テスタビリティ</name>:

<perspective-details>

- テストがしやすい設計になっているか
- 依存性の注入が適切に行われているか
- モック化が容易な構造になっているか
- テストケースの網羅性が確保されているか

</perspective-details>

</example>

<example>
<name>ユーザー体験・利便性</name>:

<perspective-details>

- エンドユーザーやAPI利用者の視点で使いやすいか
- UIが使いやすいか
- APIが直感的か

</perspective-details>

</example>

<example>
<name>プロジェクトフェーズ適合性</name>:

<perspective-details>

- 早すぎる最適化になっていないか
- MVP として妥当な範囲か
- 技術的負債とのバランスが適切か

</perspective-details>

</example>

<example>
<name>既存コードとの整合性</name>:

<perspective-details>

- プロジェクト内のパターン・スタイルと一貫性があるか
- コーディング規約が遵守されているか

</perspective-details>

</example>

<example>
<name>ベストプラクティス・標準準拠</name>:

<perspective-details>

- 公式ドキュメントに沿っているか
- コミュニティのベストプラクティスに従っているか
- 言語固有のイディオムが適切に使われているか
- 業界標準に準拠しているか

</perspective-details>

</example>

</examples>

**Taskツールの呼び出し例（8つ並列）:**

<example>

```
Task(
  subagent_type: "general-purpose",
  description: "アーキテクチャ・設計の観点からレビュー",
  prompt: "あなたは <name>アーキテクチャ・設計</name> の観点から...",
  model: "sonnet"
)

Task(
  subagent_type: "general-purpose",
  description: "パフォーマンス・効率性の観点からレビュー",
  prompt: "あなたは <name>パフォーマンス・効率性</name> の観点から...",
  model: "sonnet"
)

... (残り6つも同様に並列で呼び出し、全てmodel: "sonnet"を指定)
```

</example>

**3. 第1ラウンドの結果を整理**

8つのsubagentから返ってきた意見を整理します：

- **同じ意見をマージ**
   - 複数のsubagentが同じ指摘をしている場合は、1つにまとめる
   - 「アーキテクチャとテスタビリティの両方から同じ懸念が指摘されました」のように明記

- **過度な一般化を排除**
   - 「ベストプラクティスに従うべき」のような抽象的な指摘は除外
   - 具体的なコードや状況に即した指摘のみを残す

- **整理した結果をマークダウン形式でまとめる**

<example>

```markdown
## 第1ラウンド: 多角的レビュー結果

### 共通指摘事項
- エラーハンドリングの不足: アーキテクチャとテスタビリティの両方から、外部API呼び出し時のエラーハンドリングが不十分との指摘

### アーキテクチャ・設計
- 新しいvalidateInput関数が既存のvalidationUtilsモジュールと重複している
- 依存性注入パターンが一貫していない（一部は直接インポート、一部はコンストラクタ注入）

### パフォーマンス・効率性
- データベースクエリがN+1問題を引き起こす可能性がある
- 大量データの処理時にメモリ使用量が増加する懸念

### 保守性・可読性
- 関数の責務が多すぎる（SRP違反）
- 変数名が曖昧（例：data, result など）

### テスタビリティ
- 外部依存が直接インポートされており、モック化が困難

### ユーザー体験・利便性
- 指摘なし（この変更はバックエンドのみでUI影響なし）

### プロジェクトフェーズ適合性
- 現時点では妥当な実装（早すぎる最適化なし）

### 既存コードとの整合性
- 既存のコーディング規約（eslint設定）に準拠している
```

</example>

**4. 第2ラウンド: 妥当性検証**

第1ラウンドで整理した結果を、再度5つのsubagentに渡して妥当性を検証します。

**並列実行**: 5つのTaskツール（`subagent_type: "general-purpose"`）を同時に呼び出してください。

各general-purpose subagentには以下のプロンプトを渡します：

```
あなたは妥当性検証者として、第1ラウンドのレビュー結果を検証してください。

## 第1ラウンドの結果

[整理されたレビュー結果]

## 元のコンテキスト（検証の裏付け用）

以下は<context>タグで定義した手順に従って収集したデータです。

[git diff、git log、会話履歴などのデータをここに記載]

## 検証観点

以下の観点から、レビュー結果の妥当性を評価してください：

- **コンテキストとの整合性**
   - 提供されたコンテキスト（git diff、コミット履歴、会話内容）を踏まえた意見か
   - 抽象的すぎる指摘ではなく、具体的なコードや状況に即しているか

- **プロジェクトフェーズ適合性**
   - 早すぎる最適化や過剰な設計になっていないか
   - MVPとして妥当な範囲か
   - nitな指摘ではなく、本質的な問題か

## 回答形式

- 妥当な指摘: 「✅ [理由]」
- 疑問のある指摘: 「⚠️ [理由]」
- 不適切な指摘: 「❌ [理由]」

簡潔に（1-2文で）評価してください。
```

**5. 最終レポートの生成**

第1ラウンドと第2ラウンドの結果を統合し、以下の形式でマークダウンレポートをユーザーに報告します：

<template>

```markdown
# 複数視点レビュー結果

## レビューサマリー
- 第1ラウンド: 8つの視点からレビュー
- 第2ラウンド: 5名の検証者による妥当性確認

## 主要な指摘事項

### 妥当性が確認された指摘

**[指摘のタイトル]**
- [判定結果] [指摘内容]
- 理由: [妥当性の根拠]

### 検討が必要な指摘

**[指摘のタイトル]**
- [判定結果] [指摘内容]
- 理由: [検討が必要な理由]

### 不適切と判断された指摘

**[指摘のタイトル]**
- [判定結果] [指摘内容]
- 理由: [不適切と判断した理由]

## 詳細レビュー結果

### 第1ラウンド: 多角的レビュー

（※ 前述の整理結果を挿入）

### 第2ラウンド: 妥当性検証

**検証者の評価:**
[各検証者の評価結果を箇条書きで列挙]

## 総合評価

**優先的に対処すべき事項:**
[妥当性が高いと判断された指摘を優先度順に列挙]

**今後検討すべき事項:**
[検討が必要と判断された指摘を列挙]

**実施不要と判断された事項:**
[不適切と判断された指摘を列挙]

[総合的な評価コメント]
```

</template>

<example>

```markdown
# 複数視点レビュー結果

## レビューサマリー
- 第1ラウンド: 8つの視点からレビュー
- 第2ラウンド: 5名の検証者による妥当性確認

## 主要な指摘事項

### 妥当性が確認された指摘

**エラーハンドリングの不足**
- 外部API呼び出し時のエラーハンドリングが不十分
- 理由: 実際のコードを見ると、try-catchブロックがなく、本番環境で問題が発生する可能性が高い

**テスタビリティの問題**
- 外部依存が直接インポートされており、モック化が困難
- 理由: 具体的なコード箇所を指摘しており、テストの保守性に直結する実質的な問題

**アーキテクチャの重複**
- 新しいvalidateInput関数が既存のvalidationUtilsモジュールと重複
- 理由: コードベース全体を見ると、同じ機能が2箇所に存在し、保守性を低下させる

### 検討が必要な指摘

**パフォーマンス懸念**
- データベースクエリがN+1問題を引き起こす可能性
- 理由: 現時点のデータ量では問題にならない可能性があるが、将来的なスケールを考慮すると対処すべき

**変数名の曖昧さ**
- 変数名が曖昧（data, result など）
- 理由: プロジェクト内で一貫して使われているパターンであれば、nitな指摘の可能性

### 不適切と判断された指摘

**過剰な抽象化**
- インターフェースを追加してDI パターンを徹底すべき
- 理由: プロジェクトのフェーズを考慮すると早すぎる最適化。現時点では不要な複雑性を導入する

## 詳細レビュー結果

### 第1ラウンド: 多角的レビュー

（※ 前述の整理結果を挿入）

### 第2ラウンド: 妥当性検証

**検証者1の評価:**
- エラーハンドリング不足は妥当な指摘（実装に直接影響）
- N+1問題は現時点では過剰かもしれないが、将来的には対処が必要
- DI パターンの徹底は早すぎる最適化

**検証者2の評価:**
- テスタビリティの問題は具体的で改善価値が高い
- validationUtils との重複は明確な問題
- 変数名の指摘はプロジェクト規約次第

（以下、検証者3-7の評価を同様に列挙）

## 総合評価

**優先的に対処すべき事項:**
1. 外部API呼び出し時のエラーハンドリングを追加
2. 外部依存のモック化を容易にするため、依存性注入パターンを部分的に適用
3. validateInput関数と既存のvalidationUtilsモジュールの重複を解消

**今後検討すべき事項:**
- データベースクエリのN+1問題（データ量が増えた際に再評価）
- 変数名の見直し（チーム全体のコーディング規約を整備してから判断）

**実施不要と判断された事項:**
- 全体的なDIパターンの徹底（現フェーズでは過剰）

全体として、実装は概ね妥当な範囲にあります。上記の優先事項を対処すれば、品質とテスタビリティが大きく向上すると考えられます。
```

</example>

</procedure>

## 重要な注意事項

<important>

1. **subagentへの指示**
   - 修正を行わない（分析と意見のみ）
   - 客観的な視点を保つ
   - 具体的なコードに言及する
   - 過度に一般化しない

2. **並列実行**
   - 第1ラウンドの8つのsubagentは必ず並列で起動
   - 第2ラウンドの5つのsubagentも必ず並列で起動
   - 合計13個のsubagentを使用

3. **コンテキストの重要性**
   - git diff, git log, 会話履歴を必ず収集
   - 不足している場合は、その旨を明記

4. **出力形式**
   - 必ずマークダウン形式
   - 見出し、箇条書き、引用を活用
   - 読みやすさを重視

</important>
