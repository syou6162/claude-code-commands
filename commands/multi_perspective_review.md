---
description: "複数の視点から客観的にレビューし、方針の妥当性を検証します。"
allowed-tools: Bash(git diff:*), Bash(git log:*), Bash(git symbolic-ref refs/remotes/origin/HEAD --short)
---

# 複数視点レビューコマンド

<important>

このコマンドは以下の場合に使用してください：

- 実装方針や設計の妥当性を確認したい
- 複数の視点から客観的な意見が欲しい
- 早すぎる最適化やnit な指摘を避けたい
- プロジェクトの現状に合った判断をしたい

</important>

## 実行手順

<procedure>

### 1. コンテキストの収集

まず、レビューに必要なコンテキストを収集します：

1. **デフォルトブランチの取得**
   ```bash
   git symbolic-ref refs/remotes/origin/HEAD --short
   ```

   結果は `origin/main` のような形式なので、後続の処理で使用します

2. **現在の変更差分を取得（あれば）**

   デフォルトブランチとの差分を取得：
   ```bash
   git diff <デフォルトブランチ名>
   ```

   例: `git diff origin/main`

   ※ 変更がない場合も問題なし。これから実装する方針のレビューなど、コード差分がない場合もある

3. **最近のコミット履歴を取得（あれば）**
   ```bash
   git log -5 --oneline
   ```

4. **会話履歴の確認（重要）**
   - 直前のユーザーとのやり取りから、レビュー対象の意図を把握する
   - 「この方針で良いか確認したい」「この設計をレビューして」などの説明
   - git diffがない場合は、会話履歴が主なコンテキストになる

### 2. 第1ラウンド: 7つの視点からのレビュー

収集したコンテキストを基に、7つの異なる視点からレビューを実施します。

**並列実行**: 7つのTaskツール（`subagent_type: "general-purpose"`）を同時に呼び出し、効率的にレビューを実施してください。

各general-purpose subagentには以下の情報を含めたプロンプトを渡します：

```
あなたは「<視点名>」の観点から、以下の内容をレビューしてください。

## レビュー対象

<context>
- git diff の結果
- 最近のコミット履歴
- 会話履歴から読み取れる意図
</context>

## レビューの指針
- 客観的な視点から意見を述べてください
- 修正案の提示は不要です（分析と意見のみ）
- 具体的なコードや状況に即した指摘をしてください
- 抽象的すぎる指摘は避けてください

## あなたの視点: <視点名>

<perspective-details>
視点の詳細説明
</perspective-details>

1文から3文程度で、要点を簡潔に述べてください。
```

<decision-criteria>

| 視点 | 着眼点 |
|------|--------|
| アーキテクチャ・設計 | システム全体の構造、モジュール分割、依存関係、拡張性、設計原則の遵守 |
| パフォーマンス・効率性 | 実行速度、メモリ使用量、スケーラビリティ、アルゴリズムの計算量 |
| 保守性・可読性 | コードの理解しやすさ、変更のしやすさ、命名規則、コメント、複雑度 |
| テスタビリティ | テストのしやすさ、依存性の注入、モック可能性、テストケースの網羅性 |
| ユーザー体験・利便性 | エンドユーザーやAPI利用者の視点、UIの使いやすさ、APIの直感性 |
| プロジェクトフェーズ適合性 | 早すぎる最適化の回避、MVP としての妥当性、技術的負債とのバランス |
| 既存コードとの整合性 | プロジェクト内のパターン・スタイルとの一貫性、コーディング規約の遵守 |

</decision-criteria>

<example>

**Taskツールの呼び出し例（7つ並列）:**

```
Task(
  subagent_type: "general-purpose",
  description: "アーキテクチャ・設計の観点からレビュー",
  prompt: "あなたは「アーキテクチャ・設計」の観点から...",
  model: "sonnet"
)

Task(
  subagent_type: "general-purpose",
  description: "パフォーマンス・効率性の観点からレビュー",
  prompt: "あなたは「パフォーマンス・効率性」の観点から...",
  model: "sonnet"
)

... (残り5つも同様に並列で呼び出し、全てmodel: "sonnet"を指定)
```

</example>

### 3. 第1ラウンドの結果を整理

7つのsubagentから返ってきた意見を整理します：

1. **同じ意見をマージ**
   - 複数のsubagentが同じ指摘をしている場合は、1つにまとめる
   - 「アーキテクチャとテスタビリティの両方から同じ懸念が指摘されました」のように明記

2. **過度な一般化を排除**
   - 「ベストプラクティスに従うべき」のような抽象的な指摘は除外
   - 具体的なコードや状況に即した指摘のみを残す

3. **整理した結果をマークダウン形式でまとめる**
   ```markdown
   ## 第1ラウンド: 多角的レビュー結果

   ### 共通指摘事項
   - [複数の視点から指摘された内容]

   ### アーキテクチャ・設計
   - [具体的な指摘]

   ### パフォーマンス・効率性
   - [具体的な指摘]

   ... (以下、各視点ごとに整理)
   ```

### 4. 第2ラウンド: 妥当性検証

第1ラウンドで整理した結果を、再度7つのsubagentに渡して妥当性を検証します。

**並列実行**: 7つのTaskツール（`subagent_type: "general-purpose"`）を同時に呼び出してください。

各general-purpose subagentには以下のプロンプトを渡します：

```
あなたは妥当性検証者として、第1ラウンドのレビュー結果を検証してください。

## 第1ラウンドの結果

<round1-results>
整理されたレビュー結果
</round1-results>

## 元のコンテキスト（検証の裏付け用）

<context>
- git diff の結果
- 最近のコミット履歴
- 会話履歴から読み取れる意図
</context>

## 検証観点

以下の観点から、レビュー結果の妥当性を評価してください：

1. **コンテキストとの整合性**
   - 提供されたコンテキスト（git diff、コミット履歴、会話内容）を踏まえた意見か
   - 抽象的すぎる指摘ではなく、具体的なコードや状況に即しているか

2. **プロジェクトフェーズ適合性**
   - 早すぎる最適化や過剰な設計になっていないか
   - MVPとして妥当な範囲か
   - nitな指摘ではなく、本質的な問題か

## 回答形式

- 妥当な指摘: 「✅ [理由]」
- 疑問のある指摘: 「⚠️ [理由]」
- 不適切な指摘: 「❌ [理由]」

簡潔に（1-2文で）評価してください。
```

### 5. 最終レポートの生成

第1ラウンドと第2ラウンドの結果を統合し、マークダウン形式でユーザーに報告します：

```markdown
# 複数視点レビュー結果

## 📊 レビューサマリー
- 第1ラウンド: 7つの視点からレビュー
- 第2ラウンド: 7名の検証者による妥当性確認

## 🎯 主要な指摘事項

### ✅ 妥当性が確認された指摘
[第2ラウンドで妥当と判断された指摘を列挙]

### ⚠️ 検討が必要な指摘
[第2ラウンドで疑問が呈された指摘を列挙]

### ❌ 不適切と判断された指摘
[第2ラウンドで不適切と判断された指摘を列挙]

## 📝 詳細レビュー結果

### 第1ラウンド: 多角的レビュー
[整理された各視点からの意見]

### 第2ラウンド: 妥当性検証
[各検証者の評価]

## 💡 総合評価
[全体を通じた結論と推奨事項]
```

</procedure>

## 重要な注意事項

<important>

1. **subagentへの指示**
   - 修正を行わない（分析と意見のみ）
   - 客観的な視点を保つ
   - 具体的なコードに言及する
   - 過度に一般化しない

2. **並列実行**
   - 第1ラウンドの7つのsubagentは必ず並列で起動
   - 第2ラウンドの7つのsubagentも必ず並列で起動
   - 合計14個のsubagentを使用

3. **コンテキストの重要性**
   - git diff, git log, 会話履歴を必ず収集
   - 不足している場合は、その旨を明記

4. **出力形式**
   - 必ずマークダウン形式
   - 見出し、箇条書き、引用を活用
   - 読みやすさを重視

</important>
